name: Test SSH Connection to Raspberry Pi

on:
  workflow_dispatch:

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    environment: Raspberry
    name: Test SSH Connection

    steps:
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ vars.RASPBERRY_HOST }}
          username: ${{ secrets.RASPBERRY_USER }}
          key: ${{ secrets.RASPBERRY_SSH_KEY }}
          port: ${{ vars.RASPBERRY_PORT || 22 }}
          script: |
            echo "ğŸ‰ SSH Connection Successful!"
            echo "================================"
            echo "ğŸ“ Connected to: $(hostname)"
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸ• Date: $(date)"
            echo "ğŸ“Š Uptime: $(uptime)"
            echo "ğŸ’¾ Disk usage:"
            df -h / | tail -1
            echo "ğŸ§  Memory usage:"
            free -h | grep Mem
            echo "ğŸ³ Docker status:"
            if command -v docker &> /dev/null; then
              echo "âœ… Docker is installed"
              docker --version
              echo "ğŸ”„ Docker service status:"
              sudo systemctl is-active docker || systemctl is-active docker
              echo "ğŸ“¦ Running containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "No containers running"
            else
              echo "âŒ Docker is not installed"
            fi
            echo "ğŸŒ Network connectivity:"
            ping -c 3 google.com || echo "âŒ No internet connection"
            echo "================================"
            echo "âœ… SSH test completed successfully!"

      - name: Test Docker Permissions
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ vars.RASPBERRY_HOST }}
          username: ${{ secrets.RASPBERRY_USER }}
          key: ${{ secrets.RASPBERRY_SSH_KEY }}
          port: ${{ vars.RASPBERRY_PORT || 22 }}
          script: |
            echo "ğŸ³ Testing Docker permissions..."
            if docker ps &> /dev/null; then
              echo "âœ… Docker permissions are correct"
              echo "ğŸ“‹ Current Docker images:"
              docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | head -10
            else
              echo "âŒ Docker permission denied. User may need to be added to docker group:"
              echo "   sudo usermod -aG docker $USER"
              echo "   Then logout and login again"
            fi

      - name: Test Application Port
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ vars.RASPBERRY_HOST }}
          username: ${{ secrets.RASPBERRY_USER }}
          key: ${{ secrets.RASPBERRY_SSH_KEY }}
          port: ${{ vars.RASPBERRY_PORT || 22 }}
          script: |
            echo "ğŸ”Œ Testing application port 8080..."
            if netstat -tuln | grep :8080 &> /dev/null || ss -tuln | grep :8080 &> /dev/null; then
              echo "âœ… Port 8080 is in use"
              echo "ğŸ” Process using port 8080:"
              sudo netstat -tulnp | grep :8080 || sudo ss -tulnp | grep :8080
            else
              echo "â„¹ï¸  Port 8080 is available for the application"
            fi

      - name: Summary
        if: always()
        run: |
          echo "ğŸ¯ SSH Connection Test Summary"
          echo "============================="
          echo "âœ… SSH Connection: Successful"
          echo "ğŸ”§ Environment: Ready for deployment"
          echo "ğŸ“‹ Next steps:"
          echo "   1. All secrets are configured correctly"
          echo "   2. SSH connection is working"
          echo "   3. Ready to run the main deployment workflow"
          echo "   4. Go to Actions â†’ 'Test, Build and Deploy to Raspberry Pi' â†’ Run workflow"